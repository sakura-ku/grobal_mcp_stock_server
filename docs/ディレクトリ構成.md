# MCPサーバープロジェクトのディレクトリ構成

本プロジェクトは株式市場データにアクセスするためのMCP (Model Context Protocol) サーバーを提供します。Express.jsをベースにし、サービスレイヤーとルーターを活用した設計を採用しています。このドキュメントでは、プロジェクトのディレクトリ構成と各ディレクトリの役割について説明します。

## ルートディレクトリ構成

```
grobal_mcp_stock_server/
├── dist/                # ビルド後の出力ファイル（配布用）
├── docs/                # プロジェクトドキュメント
├── node_modules/        # npm依存関係
├── src/                 # ソースコード
│   ├── __tests__/       # テストファイル
│   ├── config/          # 設定ファイル
│   ├── data/            # データモデル
│   ├── errors/          # エラー定義
│   ├── routes/          # APIルーティング
│   ├── services/        # ビジネスロジック
│   ├── tools/           # MCPツール実装
│   ├── types/           # 型定義
│   ├── bin.ts           # CLIエントリーポイント
│   └── index.ts         # メインアプリケーションエントリーポイント
├── .env.example         # 環境変数サンプル
├── .gitignore           # Git設定
├── .npmrc               # npm設定
├── package.json         # プロジェクト構成
├── package-lock.json    # パッケージバージョン管理
├── PUBLISHING.md        # パッケージ公開手順
├── README.md            # プロジェクト概要
└── tsconfig.json        # TypeScript設定
```

## ディレクトリとファイルの説明

### ルートレベルのファイル

- **`.env.example`**: 環境変数の設定例を提供するサンプルファイル。実際の環境構築時には`.env`として複製して使用します。
- **`.gitignore`**: Gitバージョン管理の対象外とするファイルやディレクトリを指定するファイル。
- **`.npmrc`**: npm設定ファイル。GitHub Packagesの認証設定などを行います。
- **`package.json`**: NPMプロジェクト設定ファイル。依存関係やスクリプトコマンドを定義します。
- **`package-lock.json`**: NPM依存関係の正確なバージョンを固定するためのファイル。
- **`PUBLISHING.md`**: GitHub Packagesへの公開手順を説明するドキュメント。
- **`README.md`**: プロジェクトの概要、使用方法、機能などを説明するドキュメント。
- **`tsconfig.json`**: TypeScriptコンパイラの設定ファイル。

### ディレクトリ

#### `dist/`
コンパイル後のJavaScriptファイルが配置されるディレクトリ。本番環境ではここのファイルが使用されます。また、npmパッケージとして配布する際の公開ファイルもここに含まれます。Gitリポジトリ上には存在せず、`npm run build`コマンド実行時に生成されます。

#### `docs/`
プロジェクトに関するドキュメントを格納するディレクトリ。
- **`環境構築手順書.md`**: プロジェクトの環境構築手順を記載したドキュメント。
- **`ディレクトリ構成.md`**: このファイル。プロジェクトの構成を説明しています。
- **`プライベートnpmレジストリの管理方法.md`**: GitHub Packagesを使ったパッケージ管理方法の説明。
- その他必要なドキュメント（APIドキュメント、設計ドキュメントなど）。

#### `node_modules/`
npm依存関係のインストール先ディレクトリ。`npm install`コマンドによって自動的に生成されるため、バージョン管理の対象外です。

#### `src/`
アプリケーションのソースコードを格納するルートディレクトリ。

##### `src/__tests__/`
統合テストとテストユーティリティを含むディレクトリ。複数のモジュールにまたがるテストケースを配置します。

##### `src/config/`
アプリケーション設定ファイルを格納するディレクトリ。
- **`index.ts`**: 設定管理のエントリーポイント。環境変数からの読み込みや、デフォルト値の設定を行います。

##### `src/data/`
データモデルとデータアクセスレイヤーを管理するディレクトリ。
- データストレージの抽象化
- リポジトリパターンの実装
- データ永続化や一時キャッシュの管理

##### `src/errors/`
カスタムエラークラスと例外処理機能を格納するディレクトリ。
- **`index.ts`**: エラータイプの定義と例外処理の中央管理を行います。カスタムエラークラスを定義します。

##### `src/routes/`
Expressルーティングを管理するディレクトリ。APIエンドポイントの定義を行います。
- **`index.ts`**: ルーターの集約を行うファイル。機能ごとのルーターを1つのAPIルーターに統合します。
- **`stockRoutes.ts`**: 株価関連のエンドポイントを定義するルーターを実装します。

##### `src/services/`
ビジネスロジックを提供するサービスレイヤー。
- **`stockService.ts`**: 株価情報の取得や分析などの機能を提供するサービスクラスを実装します。

##### `src/tools/`
MCPツール実装を格納するディレクトリ。各ツールは特定の機能を提供するMCPサーバーの基本構成単位です。
- **`stockTools.ts`**: 株価情報を取得・分析するためのMCPツールを定義します。

##### `src/types/`
TypeScript型定義ファイルを格納するディレクトリ。
- **`stock.ts`**: 株式データに関連する型定義。
- **`express.d.ts`**: Express関連の型拡張定義。

#### `src/bin.ts`
コマンドラインからパッケージを実行するためのエントリーポイント。npmパッケージとしてインストールされた際にコマンドラインから実行可能にするために使用されます。

#### `src/index.ts`
アプリケーションのメインエントリーポイント。Express.jsアプリケーションとMCPサーバーの初期化、ルーターのマウント、サーバー起動などの処理を行います。また、外部からimportして使用するためのAPI（startServer関数など）を提供します。

## アーキテクチャの概要

このプロジェクトは、サービスレイヤーとルーターを分離した設計を採用しています。これにより、各レイヤーの責務が明確に分かれ、コードの保守性と拡張性が高まります。

### 1. ルーターレイヤー（`src/routes/`）
APIエンドポイントを定義し、クライアントからのリクエストを受け付けます。リクエストのバリデーションとレスポンスの形式化を担当し、ビジネスロジックの実行はサービスレイヤーに委譲します。

### 2. サービスレイヤー（`src/services/`）
ビジネスロジックを実装します。データの取得、処理、変換などの操作を担当し、ルーターレイヤーから呼び出されます。また、MCPツールからも再利用されます。

### 3. MCPツールレイヤー（`src/tools/`）
Model Context Protocolに準拠したツールを定義します。サービスレイヤーを呼び出してデータを取得し、MCP形式でレスポンスを返します。

### 4. 型定義（`src/types/`）
プロジェクト全体で使用される型定義を集約します。各レイヤー間のデータ構造を明確にし、型安全性を確保します。

## npmパッケージとしての構成

このプロジェクトはnpmパッケージとしても公開できるよう設計されています。主な特徴は以下の通りです：

1. **コマンドラインインターフェース**: `bin.ts`をエントリーポイントとしたCLIを提供し、`npx global-mcp-stock-server`コマンドで実行できます。

2. **モジュールとしてのインポート**: 他のプロジェクトから`import`して使用できるよう、明示的なエクスポートを提供しています。

3. **型定義の提供**: TypeScriptプロジェクトでの使用を容易にするため、`.d.ts`型定義ファイルを同梱しています。

4. **GitHub Packagesとの統合**: プライベートリポジトリを活用したnpmパッケージとして公開できます。

## ファイル配置の考え方

1. **関心の分離**: 機能ごとにディレクトリを分け、それぞれの役割を明確にしています。
2. **モジュール性**: 各ディレクトリは特定の責任を持ち、独立してテスト・開発できるよう構成されています。
3. **拡張性**: 新しいツールや機能を追加する際にも、既存の構造に沿って配置できるよう設計されています。
4. **テスト容易性**: テストファイルは関連するコードの近くに配置し、単体テストと統合テストを明確に分離しています。
5. **設定の分離**: 環境変数や設定は専用のディレクトリに集約し、環境ごとの切り替えを容易にしています。

## 新機能の追加方法

新しい機能を追加する場合、以下の手順に従うとプロジェクトの構造と一貫性を保つことができます：

1. **型定義の追加**: 必要な型を`src/types/`に定義します。
2. **サービスの実装**: ビジネスロジックを`src/services/`に実装します。
3. **ルーターの追加**: APIエンドポイントを`src/routes/`に定義し、`src/routes/index.ts`に登録します。
4. **MCPツールの定義**: 必要に応じてMCPツールを`src/tools/`に実装します。
5. **テストの追加**: 各コンポーネントのテストを適切なディレクトリに追加します。

この構成により、プロジェクトの規模が大きくなっても保守性と拡張性を維持しつつ、開発効率を高めることができます。