# 統合テスト

このディレクトリには、実際の外部APIを呼び出す統合テストが格納されています。

## 概要

統合テストは以下の特徴を持っています：

- 実際の外部APIを呼び出します
- パフォーマンスの確認や実際のレスポンス構造の検証を行います
- 通常のユニットテストより実行時間が長くなる場合があります
- API制限やコストの関係で実行頻度を制限すべき場合があります

## テストの実行方法

### 特定の統合テストを実行する

```bash
# Polygon.io APIの統合テストを実行
ENABLE_ACTUAL_API_CALLS=true npm test -- -t "Polygon.io API実際の呼び出しテスト" --testPathPattern="polygonApi.test.ts"
```

### すべての統合テストを実行する

```bash
# 統合ディレクトリのすべてのテストを実行
ENABLE_ACTUAL_API_CALLS=true npm test -- --testPathPattern="__tests__/integration"
```

## 環境変数

統合テストは以下の環境変数によって制御されます：

- `ENABLE_ACTUAL_API_CALLS`: `true`に設定されている場合のみ、実際のAPI呼び出しテストが実行されます。デフォルトでは`skip`されます。
- `POLYGON_API_KEY`: Polygon.io APIへのアクセスに必要なAPIキー。テスト実行前に必ず設定してください。

## 統合テストの設計原則

1. **最小限のテストケース**: 代表的なパターンのみをテストし、すべての組み合わせをテストしないようにします
2. **リクエスト制限の考慮**: テスト間に遅延を設ける、テストの総数を制限するなどの対策を行います
3. **スナップショットテスト**: 厳密な値の検証ではなく、構造や型の検証を中心に行います
4. **CI考慮**: CI環境では実行しないか、限定的な実行にとどめます

## 現在のテスト対象

### Polygon.io API

`polygonApi.test.ts`は以下のテストを含みます：

- 基本的な株価情報取得
  - 単一銘柄の情報取得
  - 複数銘柄のまとめて取得
  - 無効な銘柄コードのエラー処理
- 株価の履歴データ取得
  - 日次/週次の時間間隔データ取得
- 銘柄の詳細情報取得
  - 財務データや価格データの取得
- 銘柄検索機能
  - 検索クエリによる銘柄検索
- stockServiceとの統合
  - サービスレイヤーを通じたAPI呼び出し
  - トレンド分析機能の検証

## 追加予定のテスト

今後、以下の統合テストの追加を検討しています：

- 大量データ取得時のパフォーマンステスト
- エラー状態のより詳細なハンドリングテスト
- レート制限に近づいた場合の動作確認
- Polygon.io特有のエンドポイント（ティッカー情報、マーケットステータスなど）のテスト

## テスト追加時の注意点

1. `ENABLE_ACTUAL_API_CALLS`フラグの使用を忘れないこと
2. タイムアウト値を適切に設定すること（`jest.setTimeout()`）
3. リクエスト間の遅延を適切に設定すること（API制限回避）
4. 検証は厳密な値ではなく構造やプロパティの存在の確認を中心にすること
5. Polygon.io APIの利用制限（特に無料プラン）を考慮すること