# DataAnalyzerService テストケース

**更新日**: 2025-04-12

## 概要

DataAnalyzerService は OpenAI の Code Interpreter 機能を利用して、株価データや金融データの高度な分析を行うサービスです。このドキュメントでは、DataAnalyzerService の単体テスト結果と実施したテストケースの詳細を説明します。

### テスト実行サマリー

- **実行テスト数**: 9
- **成功**: 9
- **失敗**: 0
- **スキップ**: 0

## メソッド別テスト状況

### 1. analyzeData

基本的なデータ分析機能を提供するメソッドで、OpenAI Code Interpreter を使用してデータ分析を実行します。

#### 正常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| 正しく OpenAI API を呼び出し、結果を返す | ✅ | システムプロンプト、ユーザープロンプトが正しく設定され、返り値の構造が期待通りであることを確認 |
| zod スキーマによる検証が正常に動作する | ✅ | 構造化データが zod スキーマに適合する場合、正常に処理されることを確認 |

#### 異常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| スキーマ検証に失敗した場合、警告ログを出力する | ✅ | zod スキーマに適合しないデータを受け取った場合、警告ログが出力されることを確認 |
| OpenAI API がエラーを返した場合、ExternalApiError がスローされる | ✅ | API 呼び出しエラーが適切に処理され、ExternalApiError として伝播されることを確認 |

### 2. analyzeStockData

株価データの分析に特化したメソッドで、特定の株式銘柄の価格トレンドや統計指標を分析します。

#### 正常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| 株価データを正しく分析できる | ✅ | 適切な分析指示が自動生成され、analyzeData に正しく渡されることを確認 |

#### 異常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| 分析中にエラーが発生した場合、エラーが伝播される | ✅ | 内部処理でのエラーが適切に処理され、呼び出し元に伝播されることを確認 |

### 3. compareStocks

複数の株式銘柄を比較分析するメソッドで、相対パフォーマンスやリスク調整後リターンなどを評価します。

#### 正常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| 複数銘柄のデータを正しく比較分析できる | ✅ | 銘柄数に応じた分析指示が生成され、analyzeData に正しく渡されることを確認 |

#### 異常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| 比較分析中にエラーが発生した場合、エラーが伝播される | ✅ | 内部処理でのエラーが適切に処理され、呼び出し元に伝播されることを確認 |

### 4. analyzePortfolio

投資ポートフォリオを分析するメソッドで、リスク指標やパフォーマンス評価、最適化提案を行います。

#### 正常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| ポートフォリオデータを正しく分析できる | ✅ | リスクフリーレートを含む分析パラメータが正しく設定され、analyzeData に渡されることを確認 |

#### 異常系テスト

| テスト内容 | 結果 | 備考 |
|------------|------|------|
| ポートフォリオ分析中にエラーが発生した場合、エラーが伝播される | ✅ | 内部処理でのエラーが適切に処理され、呼び出し元に伝播されることを確認 |

## モックの実装

テストでは以下のコンポーネントをモック化しています：

1. **openaiService**
   - `createCodeInterpreterCompletion` - OpenAI APIリクエストをモック
   - `extractJsonFromCodeInterpreter` - JSON抽出処理をモック

2. **logger**
   - info, warn, error メソッドをモックして、ログ出力を検証

3. **dataAnalyzerService**
   - 内部メソッドのモック（他のメソッドをテストする際に使用）

## 改善点と今後の課題

1. **テスト網羅性の向上**
   - 現在は主要メソッドのみをテスト。今後、より多くのエッジケースやエラー条件のテストを追加する必要があります。

2. **実際のAPIレスポンス形式に合わせたモックの改善**
   - 現在のモックはAPIレスポンスの簡略版。実際のレスポンス形式に近づけることで、より実践的なテストが可能になります。

3. **統合テストの導入**
   - 実際のOpenAI APIと連携する統合テストを導入し、エンドツーエンドの動作を検証することが望ましいです。
   - テスト環境用のAPIキーを用意し、リクエスト回数を制限したテスト実行が検討事項です。

4. **パフォーマンステスト**
   - API呼び出しのタイムアウト処理や、大量データ処理時の挙動を検証するテストも必要です。

## 次のステップ

1. テストカバレッジレポートの生成と分析
2. 境界値テストケースの追加
3. 実際のAPIレスポンスサンプルに基づくモックの精緻化
4. CI/CDパイプラインにテスト自動実行を統合