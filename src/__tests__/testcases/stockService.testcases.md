# StockService テストケース

## 概要
StockServiceは株価に関連するデータを取得・分析するサービスクラスです。Yahoo FinanceのAPIを利用して株価データを取得し、各種分析機能を提供します。

## テスト実行結果 (2025/04/10)
**合計**: 17テスト（10成功、7失敗）

主な失敗原因:
- モックの設定エラー: `yahooFinance`のメソッドのモックが正しく動作していない
- Yahoo FinanceのAPI変更: 実際のAPI呼び出し時に "No set-cookie header present" エラーが発生

## getStockPrice(symbol: string) のテスト
- [ ] 正常系: 有効な銘柄コードを指定した場合、正しい株価データが返される（モックエラー）
- [x] 異常系: 空の銘柄コードを指定した場合、InvalidParameterErrorがスローされる
- [ ] 異常系: 存在しない銘柄コードを指定した場合、適切なエラーがスローされる（未実装）
- [ ] 異常系: Yahoo Finance APIがエラーを返した場合、適切にエラーが処理される（モックエラー）

## getMultipleStockPrices(symbols: string[]) のテスト
- [x] 正常系: 複数の有効な銘柄コードを指定した場合、すべての株価データが配列で返される
- [ ] 正常系: 一部の銘柄コードが無効でも、有効な銘柄のデータが返される（未実装）
- [x] 異常系: 空の配列を指定した場合、InvalidParameterErrorがスローされる
- [x] 異常系: nullまたはundefinedを指定した場合、InvalidParameterErrorがスローされる

## getStockHistory(symbol, interval, range) のテスト
- [ ] 正常系: 有効なパラメータで日次データを取得した場合、正しい履歴データが返される（モックエラー）
- [ ] 正常系: 週次データを指定した場合、正しい間隔のデータが返される（未実装）
- [ ] 正常系: 月次データを指定した場合、正しい間隔のデータが返される（未実装）
- [ ] 正常系: 期間を指定した場合、指定期間のデータが返される（未実装）
- [x] 異常系: 空の銘柄コードを指定した場合、InvalidParameterErrorがスローされる
- [ ] 異常系: 無効な間隔を指定した場合、適切にエラーが処理される（未実装）

## getStockDetails(symbol) のテスト
- [ ] 正常系: 有効な銘柄コードを指定した場合、財務データ、価格データ、概要データが返される（モックエラー）
- [ ] 正常系: 一部のデータが欠けている場合でも、部分的に返される（未実装）
- [x] 異常系: 空の銘柄コードを指定した場合、InvalidParameterErrorがスローされる
- [ ] 異常系: API呼び出しが失敗した場合、適切にエラーが処理される（未実装）

## analyzeStock(symbol) のテスト
- [ ] 正常系: 有効な銘柄コードを指定した場合、トレンド分析結果が返される（API接続エラー）
- [ ] 正常系: 分析に必要な指標が正しく計算される（SMA、EMA、RSI、ボリンジャーバンドなど）（未実装）
- [x] 異常系: 空の銘柄コードを指定した場合、InvalidParameterErrorがスローされる
- [ ] 異常系: 履歴データの取得に失敗した場合、適切にエラーが処理される（未実装）

## searchStocks(query) のテスト
- [ ] 正常系: 有効な検索クエリを指定した場合、検索結果が返される（モックエラー）
- [ ] 正常系: 検索結果が存在しない場合、空の配列が返される（モックエラー）
- [x] 異常系: 空のクエリを指定した場合、InvalidParameterErrorがスローされる
- [ ] 異常系: 検索APIがエラーを返した場合、適切にエラーが処理される（未実装）

## analyzePortfolio(holdings) のテスト
- [x] 正常系: 有効なポートフォリオを指定した場合、ポートフォリオのパフォーマンス分析結果が返される
- [ ] 正常系: 複数銘柄を含むポートフォリオが正しく分析される（未実装）
- [ ] 正常系: 購入価格が指定されている場合、損益が正しく計算される（未実装）
- [x] 異常系: 空のポートフォリオを指定した場合、InvalidParameterErrorがスローされる
- [ ] 異常系: 無効な銘柄を含むポートフォリオの場合、適切にエラーが処理される（未実装）

## 内部関数のテスト（プライベートメソッド）
- [ ] calculateSMA: 異なる期間でのSMA計算が正しく行われる（未実装）
- [ ] calculateEMA: 異なる期間でのEMA計算が正しく行われる（未実装）
- [ ] calculateRSI: RSIの計算が正しく行われる（未実装）
- [ ] calculateBollingerBands: ボリンジャーバンドの上下線と幅が正しく計算される（未実装）
- [ ] calculateATR: ATR（Average True Range）の計算が正しく行われる（未実装）
- [ ] calculateMACD: MACD、シグナル、ヒストグラムが正しく計算される（未実装）

## 特記事項
- テストにはYahoo Finance APIのモックが必要
  - 現在の実装ではモックが正しく設定されていない (`yahooFinance.quote.mockResolvedValue is not a function` エラーが発生)
  - `jest.mock()` の実装を修正する必要がある
- Yahoo Finance API自体に変更があった可能性（"No set-cookie header present in Yahoo's response"）
  - ライブラリの更新または代替手段の検討が必要
- パラメータバリデーションのテストは全て成功している（高い優先度の部分は実装できている）
- テクニカル指標の計算は未テスト
- モックの修正後、残りのテストケースを実装する必要がある 